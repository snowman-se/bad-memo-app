{% extends "base.html" %}
{% block title %}メモ一覧{% endblock %}
{% block content %}
  {% if legacy %}
    <div class="alert">
      <strong>旧検索モード(legacy=1)</strong>：教材用に“危険/壊れやすい実装”が動作しています。
      （例：<code>'</code> を含む検索で落ちる等）
    </div>
  {% endif %}

  <div class="card">
    <form method="get" class="row">
      <input type="text" name="q" placeholder="検索（タイトル/本文）" value="{{ q|default:'' }}" />
      <input type="text" name="tag" placeholder="タグ（1つ）" value="{{ tag|default:'' }}" />
      <select name="sort">
        <option value="new" {% if sort == "new" %}selected{% endif %}>新しい順</option>
        <option value="old" {% if sort == "old" %}selected{% endif %}>古い順</option>
        <option value="title" {% if sort == "title" %}selected{% endif %}>タイトル</option>
      </select>


      <button class="btn" type="submit">絞り込み</button>
      <a class="btn secondary" href="/">リセット</a>
    </form>
  </div>

  <div class="grid">
    {% for memo in memos %}
      <a class="card link" href="/memos/{{ memo.id }}/">
        <div class="card-title">{{ memo.title }}</div>
        <div class="muted small">{{ memo.created_at|date:"Y-m-d H:i" }}</div>
        <div class="tags">
          {% for t in memo.tags.all %}
            <span class="tag">#{{ t.name }}</span>
          {% endfor %}
        </div>
        <p class="small">{{ memo.preview }}</p>
      </a>
    {% empty %}
      <div class="card">メモがありません</div>
    {% endfor %}
  </div>

  {% if page_obj.has_other_pages %}
  <div class="card" style="margin-top: 20px;">
    <div class="pagination" style="display: flex; justify-content: space-between; align-items: center;">
      <div>
        {% if page_obj.has_previous %}
          <a href="?page={{ page_obj.previous_page_number }}{% if q %}&q={{ q }}{% endif %}{% if tag %}&tag={{ tag }}{% endif %}{% if sort %}&sort={{ sort }}{% endif %}{% if legacy %}&legacy=1{% endif %}" class="btn">← 前へ</a>
        {% else %}
          <span class="btn secondary" style="opacity: 0.5;">← 前へ</span>
        {% endif %}
      </div>
      
      <div class="muted">
        ページ {{ page_obj.number }} / {{ page_obj.paginator.num_pages }} （全 {{ page_obj.paginator.count }} 件）
      </div>
      
      <div>
        {% if page_obj.has_next %}
          <a href="?page={{ page_obj.next_page_number }}{% if q %}&q={{ q }}{% endif %}{% if tag %}&tag={{ tag }}{% endif %}{% if sort %}&sort={{ sort }}{% endif %}{% if legacy %}&legacy=1{% endif %}" class="btn">次へ →</a>
        {% else %}
          <span class="btn secondary" style="opacity: 0.5;">次へ →</span>
        {% endif %}
      </div>
    </div>
  </div>
  {% endif %}
{% endblock %}
